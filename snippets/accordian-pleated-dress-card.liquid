{% comment %}
  File: sections/accordian-pleated-dress-card.liquid
  Purpose: Modal-friendly product detail card (fragment) with editable settings.
  Notes:
  - Designed to be fetched and injected into a modal container.
  - Keep styles scoped to avoid conflicts with the landing page.
{% endcomment %}

{%- comment -%} Resolve icons with fallbacks {%- endcomment -%}
{%- assign close_icon_url = section.settings.close_icon != blank 
  ? section.settings.close_icon | image_url: width: 22 
  : 'img_group_1000008134.svg' | asset_url -%}

{%- assign dropdown_arrow_url = section.settings.dropdown_arrow != blank 
  ? section.settings.dropdown_arrow | image_url: width: 24 
  : 'img_arrow_down.svg' | asset_url -%}

{%- assign cart_arrow_url = section.settings.cart_arrow != blank 
  ? section.settings.cart_arrow | image_url: width: 48 
  : 'img_line_15_white_a700.svg' | asset_url -%}

{%- comment -%} Product image {%- endcomment -%}
{%- assign product_image_url = section.settings.product_image != blank 
  ? section.settings.product_image | image_url: width: 800 
  : 'img_image_824.png' | asset_url -%}

<style>
  /* Scoped: apd- (Accordian Pleated Dress) */
  .apd-container { background:#fff; box-shadow:0 2px 4px #00000033; width:100%; max-width:400px; margin:0 auto; padding:12px 16px 24px 16px; font-family:'Jost', Arial, sans-serif; }
  .apd-content { display:flex; flex-direction:column; align-items:center; width:100%; }
  .apd-header { display:flex; flex-direction:column; align-items:center; width:100%; margin-bottom:16px; }
  .apd-image { width:45%; height:159px; object-fit:cover; margin-bottom:-2px; margin-right:16px; }
  .apd-info { display:flex; flex-direction:column; align-items:flex-start; flex:1; gap:16px; width:100%; }
  .apd-close { width:16px; height:11px; align-self:flex-end; margin-bottom:16px; cursor:pointer; }

  .apd-details { display:flex; flex-direction:column; align-items:flex-start; width:100%; gap:10px; }
  .apd-title { font-size:14px; font-weight:300; line-height:18px; color:#000; }
  .apd-price { font-size:14px; font-family:'Lustria', serif; font-weight:400; line-height:16px; color:#000; }
  .apd-desc  { font-size:12px; font-weight:300; line-height:14px; color:#000; width:100%; }

  .apd-color { display:flex; flex-direction:column; align-items:flex-start; width:100%; max-width:272px; gap:2px; margin-top:16px; }
  .apd-label { font-size:12px; font-weight:400; line-height:16px; color:#333; }
  .apd-color-row { display:flex; align-items:center; width:100%; border:1px solid #000; }
  .apd-color-opt { padding-right:79px; display:flex; align-items:center; cursor:pointer; transition:all .3s ease; }
  .apd-color-opt:hover { opacity:.8; }
  .apd-swatch { width:7px; height:32px; border:1px solid #000; }
  .apd-swatch--primary { background-color: {{ section.settings.color_primary | default: '#B20F36' }} !important; border-color: {{ section.settings.color_primary | default: '#B20F36' }} !important; }
  .apd-swatch--secondary { background-color: {{ section.settings.color_secondary | default: '#AFAFB7' }}; border-color: {{ section.settings.color_secondary | default: '#AFAFB7' }} !important; }
  .apd-color-text { font-size:16px; font-weight:400; line-height:20px; color:#000; margin-left:8px; text-transform:capitalize; }
  .apd-color-opt.selected { background:#000; }
  .apd-color-opt.selected .apd-color-text { color:#fff; }

  .apd-size { display:flex; flex-direction:column; align-items:flex-start; width:100%; max-width:272px; gap:2px; margin-top:8px; }
  .apd-sizebar { position:relative; width:100%; border:1px solid #000; display:flex; align-items:center; cursor:pointer; user-select:none; }
  .apd-size-text { padding-left:3%; font-size:14px; font-weight:400; line-height:18px; color:#000; margin:8px 0; flex:1; }
  .apd-size-ctrl { display:inline-flex; align-items:center; gap:8px; pointer-events:none; padding:0 8px; }
  .apd-size-line { width:1px; height:30px; background:#000; }
  .apd-arrow { width:12px; height:6px; transition:transform .25s; }

  .apd-menu { position:absolute; top:110%; left:0; right:0; max-height:96px; overflow-y:auto; border:1px solid #000; background:#fff; box-shadow:0 6px 12px #0002; margin:6px 0 0; padding:0; list-style:none; display:none; z-index:1000; scrollbar-width:none; -ms-overflow-style:none; }
  .apd-menu::-webkit-scrollbar { display:none; }
  .apd-menu.show { display:block; }
  .apd-opt { padding:8px 12px; font-family:'Jost', Arial, sans-serif; font-size:14px; line-height:18px; border-bottom:1px solid #eee; cursor:pointer; }
  .apd-opt:last-child { border-bottom:none; }
  .apd-opt:hover, .apd-opt.selected { background:#000; color:#fff; }

  .apd-cta { display:flex; justify-content:flex-end; align-items:center; width:100%; max-width:272px; background:#000; padding:8px 30px; margin-top:40px; cursor:pointer; transition:all .3s ease; border:0; }
  .apd-cta:hover { background:#333; transform:translateY(-2px); }
  .apd-cta:active { transform:translateY(0); background:#555; }
  .apd-cta-text { font-size:14px; font-weight:400; line-height:18px; text-transform:uppercase; color:#fff; }
  .apd-cta-arrow { width:32px; height:1px; margin-left:28px; }

  @media (min-width:640px) {
    .apd-header { flex-direction:row; align-items:end; }
    .apd-image { height:159px; width:45%; object-fit:cover; margin-bottom:-2px; margin-right:16px; }
    .apd-info { gap:16px; }
    .apd-close { height:11px; }
    .apd-price { font-size:17px; }
    .apd-container { max-width:282px; }
    .apd-desc { font-size:14px; font-weight:200; }
    .apd-color { margin-top:-7px; }
  }

  @media (min-width:768px) {
    .apd-title { font-size:16px; line-height:24px; }
    .apd-price { font-size:16px; line-height:21px; }
    .apd-desc { font-size:13px; line-height:15px; }
    .apd-image { height:184px; margin-left:8px; }
    .apd-cta { margin-top:50px; }
    .apd-color-opt { padding-right:90px; }
    .apd-cta-text { font-size:16px; line-height:24px; }
    .apd-swatch { height:40px; }
    .apd-size-text { font-size:16px; line-height:24px; padding-left:4%; }
    .apd-size-line { height:38px; }
  }

  @media (min-width:1024px) {
    .apd-color-opt { padding-right:100px; }
    .apd-container { max-width:350px; padding:20px 32px 40px 32px; }
    .apd-desc { font-size:12px !important; }
    .apd-image { height:152px !important; margin-left:5px !important; }
  }

  /* Small devices adjustments */
  @media (min-width:0px) and (max-width:639px) {
    .apd-header { flex-direction:row; }
    .apd-details { padding-top:31px; }
    .apd-container { max-width:330px !important; position:relative; }
    .apd-image { width:123px !important; height:122px !important; margin-bottom:-34px !important; padding-left:10px !important; }
    .apd-info { padding-left:7px !important; }
    .apd-desc { font-size:13px !important; }
    .apd-color { margin-top:0 !important; }
    .apd-close { position:absolute; top:10px; right:10px; z-index:10; }
  }
</style>

<div class="apd-container">
  <div class="apd-content">
    <div class="apd-header">
      <img src="{{ product_image_url }}" alt="{{ section.settings.product_image.alt | escape | default: 'Product image' }}" class="apd-image" />
      <div class="apd-info">
        <img src="{{ close_icon_url }}" alt="Close" class="apd-close close-button" />
        <div class="apd-details">
          <h1 class="apd-title">{{ section.settings.title | default: 'Accordian Pleated Dress' }}</h1>
          <p class="apd-price">{{ section.settings.price | default: '980,00€' }}</p>
          <p class="apd-desc">
            {{ section.settings.description | default: "This one-piece swimsuit is crafted from jersey featuring an allover micro Monogram motif in relief." }}
          </p>
        </div>
      </div>
    </div>

    <div class="apd-color">
      <label class="apd-label">{{ section.settings.color_label | default: 'Color' }}</label>
      <div class="apd-color-row" id="apdColorRow">
        <div class="apd-color-opt">
          <div class="apd-swatch apd-swatch--primary"></div>
          <span class="apd-color-text">{{ section.settings.color_primary_label | default: 'Red' }}</span>
        </div>
        <div class="apd-color-opt" style="flex:1;">
          <div class="apd-swatch apd-swatch--secondary"></div>
          <span class="apd-color-text">{{ section.settings.color_secondary_label | default: 'Grey' }}</span>
        </div>
      </div>
    </div>

    <div class="apd-size">
      <label class="apd-label">{{ section.settings.size_label | default: 'Size' }}</label>
      <div class="apd-sizebar" id="apdSizeBar" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
        <span class="apd-size-text" id="apdSizeText">{{ section.settings.size_prompt | default: 'Choose your size' }}</span>
        <div class="apd-size-ctrl">
          <div class="apd-size-line"></div>
          <img src="{{ dropdown_arrow_url }}" alt="toggle" class="apd-arrow" id="apdArrow">
        </div>
        <ul class="apd-menu" id="apdMenu" role="listbox" aria-label="Size options">
          {%- assign size_list = section.settings.sizes | default: 'XS,S,M,L,XL' | split: ',' -%}
          {%- for s in size_list -%}
            {%- assign s_trim = s | strip -%}
            <li class="apd-opt" role="option" aria-selected="false">{{ s_trim }}</li>
          {%- endfor -%}
        </ul>
      </div>
    </div>

    <button class="apd-cta" type="button" id="apdAddToCart">
      <span class="apd-cta-text">{{ section.settings.cta_label | default: 'Add to cart' }}</span>
      <img src="{{ cart_arrow_url }}" alt="Arrow" class="apd-cta-arrow" />
    </button>
  </div>
</div>

<script>
  (function() {
    // Close integration: parent modal handler binds to .close-button in landing page script
    // Size dropdown
    var bar = document.getElementById('apdSizeBar');
    var menu = document.getElementById('apdMenu');
    var label = document.getElementById('apdSizeText');
    var arrow = document.getElementById('apdArrow');
    var open = false;

    function openMenu() { open = true; menu.classList.add('show'); arrow.style.transform = 'rotate(180deg)'; bar.setAttribute('aria-expanded', 'true'); }
    function closeMenu() { open = false; menu.classList.remove('show'); arrow.style.transform = 'rotate(0deg)'; bar.setAttribute('aria-expanded', 'false'); }
    function toggleMenu() { open ? closeMenu() : openMenu(); }

    if (bar) {
      bar.addEventListener('click', function(e){ e.stopPropagation(); toggleMenu(); });
      window.addEventListener('click', function(){ if (open) closeMenu(); });
      window.addEventListener('keydown', function(e){
        if (e.key === 'Escape' && open) closeMenu();
        if ((e.key === 'Enter' || e.key === ' ') && document.activeElement === bar) { e.preventDefault(); toggleMenu(); }
      });
    }

    if (menu) {
      menu.querySelectorAll('.apd-opt').forEach(function(opt){
        opt.addEventListener('click', function(e){
          e.stopPropagation();
          label.textContent = opt.textContent;
          menu.querySelectorAll('.apd-opt').forEach(function(o){ o.classList.remove('selected'); o.setAttribute('aria-selected','false'); });
          opt.classList.add('selected');
          opt.setAttribute('aria-selected','true');
          closeMenu();
        });
      });
    }

    // Color selection
    var colorOpts = document.querySelectorAll('.apd-color-opt');
    colorOpts.forEach(function(opt){
      opt.addEventListener('click', function(){
        colorOpts.forEach(function(o){ o.classList.remove('selected'); });
        opt.classList.add('selected');
      });
    });

    // Add to cart placeholder (no variant/ID context in fragment)
    var addBtn = document.getElementById('apdAddToCart');
    if (addBtn) {
      addBtn.addEventListener('click', function(){
        // Placeholder: emit a custom event for the host page to handle
        var evt = new CustomEvent('apd:add-to-cart', {
          detail: {
            title: '{{ section.settings.title | escape }}',
            price: '{{ section.settings.price | escape }}',
            size: label ? label.textContent : null
          }
        });
        window.dispatchEvent(evt);
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Accordian Pleated Dress Card",
  "settings": [
    { "type": "image_picker", "id": "product_image", "label": "Product image" },
    { "type": "text", "id": "title", "label": "Title", "default": "Accordian Pleated Dress" },
    { "type": "text", "id": "price", "label": "Price", "default": "980,00€" },
    { "type": "textarea", "id": "description", "label": "Description", "default": "This one-piece swimsuit is crafted from jersey featuring an allover micro Monogram motif in relief." },

    { "type": "image_picker", "id": "close_icon", "label": "Close icon" },
    { "type": "image_picker", "id": "dropdown_arrow", "label": "Dropdown arrow icon" },
    { "type": "image_picker", "id": "cart_arrow", "label": "Cart arrow icon" },

    { "type": "text", "id": "color_label", "label": "Color label", "default": "Color" },
    { "type": "text", "id": "color_primary_label", "label": "Primary color label", "default": "Red" },
    { "type": "color", "id": "color_primary", "label": "Primary color swatch", "default": "#B20F36" },
    { "type": "text", "id": "color_secondary_label", "label": "Secondary color label", "default": "Grey" },
    { "type": "color", "id": "color_secondary", "label": "Secondary color swatch", "default": "#AFAFB7" },

    { "type": "text", "id": "size_label", "label": "Size label", "default": "Size" },
    { "type": "text", "id": "size_prompt", "label": "Size prompt", "default": "Choose your size" },
    { "type": "text", "id": "sizes", "label": "Sizes (comma-separated)", "default": "XS,S,M,L,XL" },

    { "type": "text", "id": "cta_label", "label": "Button text", "default": "Add to cart" }
  ],
  "blocks": [],
  "presets": [
    { "name": "Accordian Pleated Dress Card" }
  ]
}
{% endschema %}
